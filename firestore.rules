rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuth() { return request.auth != null; }
    function getRole() { return request.auth.token.role; }
    function isAdmin() { return isAuth() && (getRole() == 'admin' || getRole() == 'admingeral'); }
    function isEditorOrAdmin() { return isAuth() && (getRole() == 'editor' || getRole() == 'admin' || getRole() == 'admingeral'); }
    function isAdminGeral() { return isAuth() && getRole() == 'admingeral'; }

    // Block everything by default
    match /{document=**} { allow read, write: if false; }

    // Users: any authenticated reads, admin writes
    match /users/{userId} {
      allow read: if isAuth();
      allow create, update, delete: if isAdmin();
    }

    // User secrets (passwords): ONLY admingeral reads, Cloud Functions write via Admin SDK
    match /user_secrets/{userId} {
      allow read: if isAdminGeral();
      allow write: if false;
    }

    // Materials
    match /materials/{docId} {
      allow read: if isAuth();
      allow create, update, delete: if isEditorOrAdmin();
    }

    // Categories
    match /categorias/{docId} {
      allow read: if isAuth();
      allow create, update, delete: if isEditorOrAdmin();
    }

    // Vehicles
    match /viaturas/{docId} {
      allow read: if isAuth();
      allow create, update, delete: if isEditorOrAdmin();
    }

    // Movements (cautela records)
    match /movimentacoes/{docId} {
      allow read: if isAuth();
      allow create, delete: if isEditorOrAdmin();
      allow update: if isEditorOrAdmin()
        || (isAuth()
            && resource.data.user == request.auth.token.firestoreId
            && request.resource.data.diff(resource.data).affectedKeys()
                .hasOnly(['signed', 'signed_date', 'user_acknowledged_return']));
    }

    // Rings
    match /rings/{docId} {
      allow read: if isAuth();
      allow create, update, delete: if isEditorOrAdmin();
    }

    // Maintenance
    match /manutencoes/{docId} {
      allow read: if isAuth();
      allow create, update, delete: if isEditorOrAdmin();
    }

    // Maintenance history
    match /historico_manutencoes/{docId} {
      allow read: if isAuth();
      allow create, update, delete: if isEditorOrAdmin();
    }
  }
}
